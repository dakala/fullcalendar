<?php
// $Id$

/**
 * @file
 * Provides a views style plugin for FullCalendar
 */

/**
 * Implementation of hook_views_api().
 */
function fullcalendar_views_api() {
  return array(
    'api' => '2',
    'path' => drupal_get_path('module', 'fullcalendar'),
  );
}

/**
 * Implementation of hook_init().
 */
function fullcalendar_init() {
  $path = drupal_get_path('module', 'fullcalendar');

  drupal_add_css($path . '/fullcalendar.css', 'module');
  drupal_add_js($path . '/fullcalendar.js', 'module');

  // We need some jQuery UI files.
  $files = array(
    'ui.draggable',
    'ui.droppable',
    'ui.resizable',
    'effects.highlight',
  );
  jquery_ui_add($files);
}

/**
 * Implementation of hook_perm().
 *
 * @return array An array of valid permissions for the fullcalendar module
 */
function fullcalendar_perm() {
  return array('update any fullcalendar event');
}

/**
 * Implementation of hook_menu().
 *
 * @return An array of menu items.
 */
function fullcalendar_menu() {
  $items = array();

  $items['fullcalendar/ajax/update/%/%node'] = array(
    'title' => 'Update event',
    'description' => 'Save the updated event datetime.',
    'page callback' => 'fullcalendar_update',
    'page arguments' => array(3, 4),
    'access callback' => '_fullcalendar_update_access',
    'access arguments' => array(4),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Save the updated fullcalendar event's datetime.
 *
 * @param string $action
 *   Value can be 'drop' or 'resize'.
 * @param object $node
 */
function fullcalendar_update($action, $node) {
  // Retrieve the post vars form the ajax call.
  $field = $_POST['field'];
  $index = $_POST['index'];
  $all_day = isset($_POST['all_day']) ? $_POST['all_day'] : '';
  $day_delta = $_POST['day_delta'];
  $minute_delta = $_POST['minute_delta'];

  if (!empty($field) && isset($index)) {
    $old_start = $node->{$field}[$index]['value'];
    $old_end = $node->{$field}[$index]['value2'];

    switch ($action) {
      case 'drop':
        $node->{$field}[$index]['value'] = date('Y-m-d H:i:s', strtotime($old_start . ' ' . $day_delta . ' days ' . $minute_delta . ' minutes'));
        $node->{$field}[$index]['value2'] = date('Y-m-d H:i:s', strtotime($old_end . ' ' . $day_delta . ' days ' . $minute_delta . ' minutes'));
        break;
      case 'resize':
        $node->{$field}[$index]['value2'] = date('Y-m-d H:i:s', strtotime($old_end . ' ' . $day_delta . ' days ' . $minute_delta . ' minutes'));
        break;
    }

    // Save the new start/end values.
    node_save($node);

    drupal_json(array('msg' => 'The new event time has been saved. [<a href="javascript:void(0);" class="fullcalendar-status-close">close</a>]'));
  }
}

//Pass through to template_preprocess_views_view_fields so that fields will be available to template file
//function template_preprocess_views_view_fields_fullcalendar(&$vars) {
//  template_preprocess_views_view_fields($vars);
//}

/**
 * Implementation of hook_theme().
 */
function fullcalendar_theme() {
  return array(
    'fullcalendar_classname' => array(
      'arguments' => array('node' => NULL),
    ),
    'fullcalendar_link' => array(
      'arguments' => array(
        'node' => NULL,
        'attributes' => NULL,
        'index' => NULL,
      ),
    ),
  );
}

/**
 * Construct CSS classes for a node.
 *
 * @param $node
 *   An object representing the node.
 *
 * @return
 *   A string suitable for use as a CSS class.
 */
function theme_fullcalendar_classname($node) {
  $className = array(
    'fc-event-default',
    $node->type,
  );
  return implode(' ', $className);
}

/**
 * Pass settings to JavaScript.
 */
function template_preprocess_views_view_fullcalendar(&$vars) {
  $settings = array(
    'defaultView' => $vars['options']['display']['fc_view'],
    'firstDay' => $vars['options']['display']['fc_firstday'],
    'weekMode' => $vars['options']['display']['fc_weekmode'],
    'theme' => $vars['options']['modules']['fc_theme'],
    'colorbox' => $vars['options']['modules']['fc_url_colorbox'],
    'left' => $vars['options']['header']['fc_left'],
    'center' => $vars['options']['header']['fc_center'],
    'right' => $vars['options']['header']['fc_right'],
    'year' => $vars['options']['defaults']['fc_year'],
    'month' => $vars['options']['defaults']['fc_month'],
    'day' => $vars['options']['defaults']['fc_day'],
    'agenda' => $vars['options']['times']['fc_timeformat'],
    'clock' => $vars['options']['times']['fc_clock'],
  );
  drupal_add_js(array('fullcalendar' => $settings), 'setting');
  drupal_add_js(drupal_get_path('module', 'fullcalendar') . '/fullcalendar.views.js', 'module');
}

//Prepare variables for template file invoked for node row type
function template_preprocess_views_view_node_fullcalendar(&$vars) {
  if (isset($vars['view']->empty)) {
    $vars['empty_text'] = $vars['view']->empty;
    return;
  }
  $nid = $vars['row']->{$vars['field_alias']};
  if (!is_numeric($nid)) {
    return;
  }
  $node = node_load($nid);
  if (empty($node)) {
    return;
  }

  // Allow resize/drag/drop of an event if user has proper permissions.
  $node->editable = _fullcalendar_update_access($node);
  $node->class = theme('fullcalendar_classname', $node);
  $vars['node'] = $node;
  $vars['data'] = array(); // Contains the start, end & allDay values.
  $node->url = 'node/' . $nid;
  if ($url_field = $vars['options']['fullcalendar_url_field']) {
    if (isset($node->{$url_field}[0]['value'])) {
      $node->url = $node->{$url_field}[0]['value'];
    }
  }

  $title_field = $vars['options']['fullcalendar_title_field'];
  if (!empty($title_field) && !empty($node->{$title_field}[0]['value'])) {
    $node->title = $node->{$title_field}[0]['value'];
  }
  $display_field = fullcalendar_date_fields($node);
  $field_names = trim(strip_tags($vars['options']['fullcalendar_date_fields']));
  if (!empty($field_names)) {
    foreach (explode("\n", $field_names) as $field_name) {
      $field_name = trim(strip_tags($field_name));
      if (($field_name == 'created') || ($field_name == 'changed')) {
        $attributes = _fullcalendar_set_display_times($node, $field_name);
        $vars['data'][] = theme('fullcalendar_link', $node, $attributes);
        $display_field = array();
        break;
      }
      // If a date_type field exists
      if ($display_field[$field_name]) {
        $display_field = array($field_name => $display_field[$field_name]);
        break;
      }
    }
  }
  // Iterate through available fields, using the first one found.
  foreach ($display_field as $field_name => $field) {
    foreach ($node->$field_name as $index => $item) {
      $attributes = _fullcalendar_set_display_times($node, $field_name, $field, $item);
      $vars['data'][] = theme('fullcalendar_link', $node, $attributes, $index);
    }
    break;
  }
}

/**
 * Pass times through date modules date_formatter_process function to
 * translate them to the right display times.
 *
 * @param object $node
 * @param string $field_name
 * @param integer $index
 * @param array $vars
 */
function _fullcalendar_set_display_times($node, $field_name, $field = NULL, $item = NULL) {
  if (is_array($node->$field_name)) {
    $dfp_info = array(
      '#node' => $node,
      '#field_name' => $field_name,
      '#formatter' => NULL,
      '#item' => $item,
    );
    $date = date_formatter_process($dfp_info);
    $date1 = $date['value']['local']['object'];
    $date2 = $date['value2']['local']['object'];
  }
  else {
    $date1 = date_make_date($node->$field_name, date_default_timezone(), DATE_UNIX);
    $date2 = $date1;
  }
  return array(
    'field' => $field_name,
    'allDay' => date_field_all_day($field, $date1, $date2),
    'start' => $date1,
    'end' => $date2,
    'nid' => $node->nid,
    'cn' => $node->class,
    'title' => $node->title,
    'class' => 'fullcalendar_event_details',
    'editable' => $node->editable,
  );
}

function theme_fullcalendar_link($node, $attributes, $index = 0) {
  $text = date_format_date($attributes['start']);
  if (!$attributes['allDay']) {
    $text .= ' to ' . date_format_date($attributes['end']);
  }

  $attributes['index'] = $index;
  $attributes['start'] = date_format($attributes['start'], DATE_FORMAT_DATETIME);
  $attributes['end'] = date_format($attributes['end'], DATE_FORMAT_DATETIME);

  return l($text, $node->url, array('attributes' => $attributes));
}

/**
 * Check if the user has access to update the given fullcalendar event.
 *
 * @param object $node
 * @return bool
 */
function _fullcalendar_update_access($node) {
  global $user;

  if (!empty($node) && (user_access('administer nodes')
      || user_access('update any fullcalendar event')
      || user_access('edit any ' . $node->type . ' content')
      || (user_access('edit own ' . $node->type . ' content') && $node->uid == $user->uid))) {
        return TRUE;
  }

  return FALSE;
}

function fullcalendar_date_fields($node) {
  $type = content_types($node->type);
  $fields = array();
  foreach ($type['fields'] as $field_name => $field) {
    if (in_array($field['type'], array('date', 'datestamp', 'datetime'))) {
      $fields[$field_name] = $field;
    }
  }
  return $fields;
}
